<!DOCTYPE html>
<html dir="rtl" lang="ar">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>لوحة التحكم - نظام مراجعة الوثائق</title>
    <link rel="stylesheet" type="text/css" href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css">
    <script type="text/javascript" src="https://cdn.jsdelivr.net/npm/toastify-js"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Cairo', sans-serif;
        }

        :root {
            --primary: #3b82f6;
            --primary-dark: #2563eb;
            --secondary: #f43f5e;
            --dark: #0f172a;
            --light: #f8fafc;
            --gray: #64748b;
            --white: #ffffff;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
        }

        body {
            background: var(--light);
            color: var(--dark);
            padding-top: 60px; /* مساحة للهيدر الثابت */
            min-height: 100vh;
        }

        .header {
            height: 60px;
            background: var(--white);
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            z-index: 100;
            box-shadow: 0 1px 3px rgba(0,0,0,0.1);
        }

        .header-content {
            height: 100%;
            padding: 0 1rem;
            display: flex;
            align-items: center;
            justify-content: space-between;
        }

        .user-info {
            display: flex;
            align-items: center;
            gap: 1rem;
        }

        .user-name {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-weight: 600;
        }

        .user-name .welcome {
            color: var(--gray);
        }

        .user-name .name {
            color: var(--primary);
            font-weight: 700;
        }

        .institute-name {
            color: var(--gray);
            font-size: 0.9rem;
            border-right: 2px solid var(--light);
            padding-right: 1rem;
        }

        .main-container {
            padding: 1rem;
            max-width: 1200px;
            margin: 0 auto;
        }

        .welcome-section {
            background: linear-gradient(135deg, var(--primary) 0%, var(--primary-dark) 100%);
            border-radius: 20px;
            padding: 2.5rem 1.5rem;
            color: var(--white);
            text-align: center;
            margin: 1rem;
            box-shadow: 0 10px 25px rgba(59, 130, 246, 0.2);
            position: relative;
            overflow: hidden;
        }

        .welcome-section::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: linear-gradient(45deg, transparent 0%, rgba(255,255,255,0.1) 100%);
        }

        .welcome-section h1 {
            font-size: 1.6rem;
            margin-bottom: 1rem;
            font-weight: 700;
            text-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }

        .welcome-section p {
            font-size: 1.1rem;
            opacity: 0.95;
        }

        .dashboard-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 1.2rem;
            padding: 1rem;
            margin-bottom: 4rem;
        }

        .dashboard-card {
            background: var(--white);
            border-radius: 20px;
            padding: 1.5rem 1rem;
            min-height: 180px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 0.8rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            cursor: pointer;
            position: relative;
            overflow: hidden;
        }

        .dashboard-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: var(--primary);
            transform: scaleX(0);
            transition: transform 0.3s ease;
        }

        .dashboard-card:hover::before {
            transform: scaleX(1);
        }

        .dashboard-card i {
            font-size: 2.5rem;
            color: var(--primary);
            width: 80px;
            height: 80px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 20px;
            background: var(--light);
            transition: all 0.3s ease;
            margin-bottom: 0.5rem;
        }

        .dashboard-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 12px 20px rgba(0,0,0,0.1);
            background: linear-gradient(to bottom right, var(--white), var(--light));
        }

        .dashboard-card:hover i {
            background: var(--primary);
            color: var(--white);
            transform: scale(1.1) rotate(8deg);
            box-shadow: 0 5px 15px rgba(59, 130, 246, 0.3);
        }

        .dashboard-card h3 {
            font-size: 1.2rem;
            color: var(--dark);
            font-weight: 600;
            text-align: center;
            transition: all 0.3s ease;
        }

        .dashboard-card:hover h3 {
            color: var(--primary);
            transform: scale(1.05);
        }

        .menu-btn {
            background: var(--light);
            border: none;
            width: 40px;
            height: 40px;
            border-radius: 10px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .menu-btn:hover {
            background: var(--primary);
            color: var(--white);
        }

        .sidebar {
            background: var(--white);
            position: fixed;
            left: -280px;
            top: 0;
            width: 280px;
            height: 100vh;
            z-index: 1000;
            transition: all 0.3s ease;
            box-shadow: var(--shadow);
        }

        .sidebar.active {
            left: 0;
        }

        .sidebar-header {
            padding: 1.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid var(--light);
        }

        .close-sidebar {
            background: var(--light);
            border: none;
            width: 35px;
            height: 35px;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            color: var(--dark);
            transition: all 0.3s ease;
        }

        .close-sidebar:hover {
            background: var(--primary);
            color: var(--white);
        }

        .menu-item {
            padding: 1rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 1rem;
            color: var(--dark);
            text-decoration: none;
            transition: all 0.3s ease;
        }

        .menu-item:hover {
            background: var(--light);
            color: var(--primary);
        }

        .menu-item.danger {
            color: var(--secondary);
        }

        .menu-item.danger:hover {
            background: #fee2e2;
        }

        @media (min-width: 640px) {
            .dashboard-grid {
                grid-template-columns: repeat(3, 1fr);
            }
        }

        @media (min-width: 1024px) {
            .dashboard-grid {
                grid-template-columns: repeat(4, 1fr);
            }

            .welcome-section {
                padding: 2.5rem;
            }

            .welcome-section h1 {
                font-size: 1.8rem;
            }

            .dashboard-card {
                padding: 1.5rem;
            }

            .dashboard-card i {
                font-size: 2rem;
                width: 60px;
                height: 60px;
            }

            .dashboard-card h3 {
                font-size: 1rem;
            }
        }

        /* تحسينات للموبايل */
        @media (max-width: 639px) {
            body {
                padding-top: 56px;
            }

            .header {
                height: 56px;
            }

            .user-info {
                display: flex;
                flex-direction: column;
                align-items: flex-start;
                gap: 0.2rem;
            }

            .user-name {
                font-size: 0.9rem;
            }

            .institute-name {
                font-size: 0.8rem;
                color: var(--gray);
            }

            .main-container {
                padding: 0.75rem;
            }

            .welcome-section {
                margin: 0.8rem;
                padding: 2rem 1rem;
            }

            .welcome-section h1 {
                font-size: 1.4rem;
            }

            .welcome-section p {
                font-size: 1rem;
            }

            .dashboard-grid {
                gap: 1rem;
                padding: 0.8rem;
            }

            .dashboard-card {
                padding: 1.2rem 1rem;
                min-height: 140px;
                gap: 0.3rem;
            }

            .dashboard-card i {
                font-size: 1.8rem;
                width: 50px;
                height: 50px;
                margin-bottom: 0.2rem;
            }

            .dashboard-card h3 {
                font-size: 0.95rem;
                margin-bottom: 0.3rem;
            }

            .card-buttons {
                gap: 0.4rem;
                margin-top: 0.5rem;
            }

            .action-btn {
                padding: 0.4rem;
                font-size: 0.75rem;
                border-radius: 4px;
                height: 32px;
            }

            .action-btn i {
                font-size: 0.8rem;
                margin: 0 0.2rem;
                width: auto;
                height: auto;
            }

            .upload-btn {
                background: var(--primary);
                box-shadow: none;
            }

            .gallery-btn {
                background: #f1f5f9;
                box-shadow: none;
            }

            .dashboard-card {
                display: flex;
                flex-direction: column;
                justify-content: space-between;
            }

            .dashboard-card:hover {
                transform: none;
                box-shadow: 0 4px 6px rgba(0,0,0,0.05);
            }

            .dashboard-card:hover i {
                transform: none;
                animation: none;
                background: var(--light);
                color: var(--primary);
                box-shadow: none;
            }

            .dashboard-card:hover h3 {
                transform: none;
                color: var(--dark);
            }

            .dashboard-card i {
                animation: none;
            }

            /* إزالة تأثيرات hover من الأزرار */
            .action-btn:hover {
                transform: none;
            }

            .upload-btn:hover {
                background: var(--primary);
            }

            .gallery-btn:hover {
                background: #f1f5f9;
            }

            /* إضافة تأثير عند الضغط فقط */
            .action-btn:active {
                opacity: 0.9;
                transform: scale(0.98);
            }
        }

        /* تأثيرات حركية محسنة */
        @keyframes float {
            0% { transform: translateY(0px); }
            50% { transform: translateY(-5px); }
            100% { transform: translateY(0px); }
        }

        .dashboard-card i {
            animation: float 3s ease-in-out infinite;
        }

        @keyframes fadeInScale {
            from {
                opacity: 0;
                transform: scale(0.9);
            }
            to {
                opacity: 1;
                transform: scale(1);
            }
        }

        .dashboard-card {
            animation: fadeInScale 0.5s ease backwards;
            animation-delay: calc(0.1s * var(--i));
        }

        .layout {
            display: flex;
            min-height: 100vh;
            position: relative;
        }

        .sidebar-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.5);
            backdrop-filter: blur(2px);
            z-index: 999;
            display: none;
        }

        .sidebar-menu {
            padding: 1rem;
        }

        .menu-divider {
            height: 1px;
            background: #eee;
            margin: 1rem 0;
        }

        .menu-btn {
            background: none;
            border: none;
            color: #666;
            font-size: 1.2rem;
            cursor: pointer;
            padding: 0.5rem;
            margin-right: auto;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
        }

        .menu-btn:hover {
            color: #4CAF50;
        }

        .main-content {
            flex: 1;
            margin-right: 0;
            width: 100%;
        }

        .powered-by {
            text-align: center;
            padding: 1.2rem;
            background: var(--white);
            color: var(--gray);
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            box-shadow: 0 -2px 10px rgba(0,0,0,0.05);
            backdrop-filter: blur(10px);
        }

        .powered-by span {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
            letter-spacing: 1px;
        }

        /* إضافة تأثير نبض للأيقونات */
        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.05); }
            100% { transform: scale(1); }
        }

        .dashboard-card:hover i {
            animation: pulse 1s infinite;
        }

        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            backdrop-filter: blur(5px);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
            opacity: 1;
            transition: opacity 0.3s ease;
        }

        .loading-overlay.hidden {
            opacity: 0;
            pointer-events: none;
        }

        .loading-content {
            text-align: center;
            padding: 2rem;
        }

        .loading-spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        .loading-content p {
            color: var(--dark);
            font-size: 1.1rem;
            margin: 0;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        /* إخفاء المحتوى الرئيسي أثناء التحميل */
        .dashboard-container {
            opacity: 0;
            transition: opacity 0.3s ease;
        }

        .dashboard-container.loaded {
            opacity: 1;
        }

        .dashboard-card.has-files {
            border-top: 3px solid var(--primary);
        }
        .dashboard-card.has-files i {
            color: var(--primary);
        }

        .card-buttons {
            display: flex;
            gap: 0.5rem;
            width: 100%;
            margin-top: 0.5rem;
        }

        .action-btn {
            flex: 1;
            padding: 0.5rem;
            border: none;
            border-radius: 8px;
            font-size: 0.9rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            transition: all 0.3s ease;
        }

        .upload-btn {
            background: var(--primary);
            color: white;
        }

        .gallery-btn {
            background: var(--light);
            color: var(--dark);
        }

        .upload-btn:hover {
            background: var(--primary-dark);
        }

        .gallery-btn:hover {
            background: #e2e8f0;
        }

        .action-btn i {
            font-size: 1rem;
            animation: none;
        }

        /* تحديث الريسبونسف */
        @media (max-width: 639px) {
            .card-buttons {
                flex-direction: column;
            }
            
            .action-btn {
                width: 100%;
                padding: 0.8rem;
            }
        }

        /* إضافة ستايل للنافذة المنبثقة */
        .report-modal {
            display: none;
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            background: var(--white);
            padding: 2rem;
            border-radius: 20px;
            box-shadow: 0 10px 25px rgba(0,0,0,0.2);
            z-index: 1001;
            width: 90%;
            max-width: 400px;
            text-align: center;
        }

        .report-modal h3 {
            color: var(--primary);
            margin-bottom: 1rem;
            font-size: 1.4rem;
        }

        .report-modal p {
            color: var(--gray);
            margin-bottom: 1.5rem;
            line-height: 1.6;
        }

        .phone-number {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 1rem;
            margin: 1rem 0;
            padding: 1rem;
            background: var(--light);
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        .phone-number:hover {
            background: #e2e8f0;
        }

        .phone-number i {
            color: var(--primary);
            font-size: 1.2rem;
        }

        .phone-number span {
            color: var(--dark);
            font-size: 1.1rem;
            font-weight: 600;
        }

        .close-modal {
            position: absolute;
            top: 1rem;
            left: 1rem;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            transition: color 0.3s ease;
        }

        .close-modal:hover {
            color: var(--primary);
        }

        .app-info {
            display: flex;
            flex-direction: column;
            gap: 0.2rem;
        }

        .welcome-text {
            color: var(--gray);
            font-size: 0.9rem;
        }

        .app-name {
            color: var(--primary);
            font-weight: 700;
            font-size: 1.1rem;
        }

        .notifications-btn {
            position: relative;
            cursor: pointer;
            padding: 8px;
            color: var(--gray);
            transition: all 0.3s ease;
        }

        .notifications-btn:hover {
            color: var(--primary);
        }

        .notifications-count {
            position: absolute;
            top: 0;
            right: 0;
            background: var(--secondary);
            color: white;
            font-size: 0.7rem;
            padding: 2px 6px;
            border-radius: 10px;
            min-width: 18px;
            text-align: center;
        }

        .notifications-menu {
            display: none;
            position: fixed;
            top: 60px;
            right: 1rem;
            width: 320px;
            background: var(--white);
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            z-index: 1000;
        }

        .notifications-menu.active {
            display: block;
        }

        .notifications-header {
            padding: 1rem;
            border-bottom: 1px solid var(--light);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .notifications-header h3 {
            color: var(--dark);
            font-size: 1.1rem;
        }

        .close-notifications {
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            padding: 5px;
        }

        .notifications-list {
            max-height: 400px;
            overflow-y: auto;
            padding: 0.5rem;
        }

        .notification-item {
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 0.5rem;
            cursor: pointer;
            transition: all 0.3s ease;
            display: flex;
            align-items: flex-start;
            gap: 1rem;
        }

        .notification-item:hover {
            background: var(--light);
        }

        .notification-item.unread {
            background: #f0f7ff;
        }

        .notification-icon {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.2rem;
        }

        .notification-icon.comment {
            background: #e0f2fe;
            color: #0284c7;
        }

        .notification-icon.approval {
            background: #dcfce7;
            color: #16a34a;
        }

        .notification-icon.rejection {
            background: #fee2e2;
            color: #dc2626;
        }

        .notification-content {
            flex: 1;
        }

        .notification-title {
            font-size: 0.9rem;
            color: var(--dark);
            margin-bottom: 0.3rem;
        }

        .notification-time {
            font-size: 0.8rem;
            color: var(--gray);
        }

        @media (max-width: 768px) {
            .notifications-menu {
                width: calc(100% - 2rem);
                top: 50px;
            }
        }

        .header-buttons {
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .notifications-loading {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            gap: 1rem;
        }

        .notifications-loading .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid var(--light);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        .notifications-loading p {
            color: var(--gray);
            font-size: 0.9rem;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .loading-notifications {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            padding: 2rem;
            gap: 1rem;
        }

        .loading-spinner {
            width: 30px;
            height: 30px;
            border: 3px solid rgba(59, 130, 246, 0.1);
            border-top: 3px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .notifications-count.pulse {
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0% { transform: scale(1); }
            50% { transform: scale(1.1); }
            100% { transform: scale(1); }
        }

        .modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }

        .modal-content {
            background: var(--white);
            padding: 2rem;
            padding-top: 3rem;
            border-radius: 16px;
            text-align: center;
            width: 90%;
            max-width: 350px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
            position: relative;
            margin: 20px auto;
        }

        .recording-indicator {
            margin-bottom: 1.5rem;
            min-height: 120px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
        }

        .wave {
            width: 80px;
            height: 80px;
            background: var(--primary);
            border-radius: 50%;
            margin: 0 auto 1rem;
            animation: pulse 1.5s infinite ease-in-out;
        }

        .loading-spinner {
            width: 80px;
            height: 80px;
            border: 4px solid var(--light);
            border-top: 4px solid var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        #recordingStatus {
            font-size: 1.1rem;
            color: var(--dark);
            margin-top: 1rem;
            min-height: 2.5em;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            transition: all 0.3s ease;
        }

        .processing-text {
            color: var(--gray);
            font-size: 1rem;
            margin-top: 0.5rem;
        }

        .stop-btn {
            background: var(--secondary);
            color: white;
            border: none;
            padding: 0.8rem 1.5rem;
            border-radius: 8px;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 0.5rem;
            font-size: 1rem;
            margin: 0 auto;
            transition: all 0.3s ease;
            min-width: 150px;
        }

        .stop-btn:hover {
            background: #e11d48;
            transform: translateY(-2px);
        }

        @keyframes pulse {
            0% { transform: scale(0.95); opacity: 0.5; }
            50% { transform: scale(1.05); opacity: 0.8; }
            100% { transform: scale(0.95); opacity: 0.5; }
        }

        /* تصميم زر المساعد الذكي */
        .ai-assistant-btn {
            position: fixed;
            bottom: 20px;
            right: 20px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #3b82f6 0%, #2563eb 100%);
            border: none;
            box-shadow: 0 2px 8px rgba(37, 99, 235, 0.4);
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.3s ease;
            z-index: 999;
        }

        .ai-assistant-btn i {
            font-size: 1.5rem;
            color: white;
            transition: transform 0.3s ease;
        }

        .ai-assistant-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 15px rgba(37, 99, 235, 0.4);
        }

        

        .ai-assistant-btn.recording {
            animation: pulse 1.5s infinite;
        }

        /* تحديث أنماط زر الخروج */
        .close-btn {
            position: absolute;
            top: 10px;
            left: 10px;
            background: none;
            border: none;
            color: var(--gray);
            cursor: pointer;
            font-size: 1.2rem;
            padding: 5px;
            transition: all 0.3s ease;
        }

        .close-btn:hover {
            color: var(--secondary);
            transform: scale(1.1);
        }
    </style>
</head>
<body>
    <div class="layout">
        <header class="header">
            <div class="header-content">
                <div class="app-info">
                    <div class="welcome-text">مرحباً بكم</div>
                </div>
                <div class="header-buttons">
                    <div class="notifications-btn" id="notificationsBtn">
                        <i class="fas fa-bell"></i>
                        <span class="notifications-count" id="notificationsCount">0</span>
                    </div>
                    <button class="menu-btn" id="menuBtn">
                        <i class="fas fa-bars"></i>
                    </button>
                </div>
            </div>
        </header>

        <div class="dashboard-container">
            <section class="welcome-section">
                <h1>تطبيق ادارة الجودة</h1>
                <p>اختر أحد الأقسام للبدء في إدارة الوثائق والصور</p>
            </section>

            <div class="dashboard-grid">
                <!-- الهيكل التنظيمي -->
                <div class="dashboard-card" style="--i:1">
                    <i class="fas fa-sitemap"></i>
                    <h3>الهيكل التنظيمي</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('hierarchy')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('hierarchy')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- اجتماعات القيادة -->
                <div class="dashboard-card" style="--i:2">
                    <i class="fas fa-users-cog"></i>
                    <h3>اجتماعات القيادة</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('leadership-meetings')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('leadership-meetings')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- اجتماعات المشرفين -->
                <div class="dashboard-card" style="--i:3">
                    <i class="fas fa-chalkboard-teacher"></i>
                    <h3>اجتماعات المشرفين</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('supervisor-meetings')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('supervisor-meetings')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- اجتماعات الأسر -->
                <div class="dashboard-card" style="--i:4">
                    <i class="fas fa-user-friends"></i>
                    <h3>اجتماعات الأسر</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('family-meetings')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('family-meetings')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- الأخصائي الاجتماعي -->
                <div class="dashboard-card" style="--i:5">
                    <i class="fas fa-hands-helping"></i>
                    <h3>الأخصائي الاجتماعي</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('social-specialist')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('social-specialist')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- أمين المكتبة -->
                <div class="dashboard-card" style="--i:6">
                    <i class="fas fa-book-reader"></i>
                    <h3>أمين المكتبة</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('librarian')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('librarian')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- سجل التربية الرياضية -->
                <div class="dashboard-card" style="--i:7">
                    <i class="fas fa-running"></i>
                    <h3>سجل التربية الرياضية</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('sports')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('sports')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- صور عامة ولوحات المعهد -->
                <div class="dashboard-card" style="--i:8">
                    <i class="fas fa-images"></i>
                    <h3>صور عامة ولوحات المعهد</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('general-photos')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('general-photos')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- النتيجة -->
                <div class="dashboard-card" style="--i:9">
                    <i class="fas fa-poll"></i>
                    <h3>النتيجة</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('results')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('results')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- الغياب -->
                <div class="dashboard-card" style="--i:10">
                    <i class="fas fa-user-clock"></i>
                    <h3>الغياب</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('attendance')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('attendance')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- المجالات -->
                <div class="dashboard-card" style="--i:11">
                    <i class="fas fa-th-large"></i>
                    <h3>المجالات</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('domains')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('domains')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>

                <!-- الملاحظات -->
                <div class="dashboard-card" style="--i:12">
                    <i class="fas fa-clipboard-list"></i>
                    <h3>الملاحظات</h3>
                    <div class="card-buttons">
                        <button onclick="navigateToUpload('notes')" class="action-btn upload-btn">
                            <i class="fas fa-upload"></i>
                            رفع ملفات
                        </button>
                        <button onclick="navigateToGallery('notes')" class="action-btn gallery-btn">
                            <i class="fas fa-images"></i>
                            المعرض
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <div class="sidebar-overlay" id="sidebarOverlay"></div>
        <aside class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h3>القائمة</h3>
                <button class="close-sidebar" id="closeSidebar">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="sidebar-menu">
                <a href="profile.html" class="menu-item">
                    <i class="fas fa-user"></i>
                    <span>الملف الشخصي</span>
                </a>
                <a href="#" class="menu-item" onclick="reportIssue()">
                    <i class="fas fa-exclamation-circle"></i>
                    الإبلاغ عن مشكلة
                </a>
                <div class="menu-divider"></div>
                <a href="#" class="menu-item danger" onclick="logout()">
                    <i class="fas fa-sign-out-alt"></i>
                    تسجيل خروج
                </a>
            </div>
        </aside>

        <!-- إضافة HTML للتحميل -->
        <div id="loadingOverlay" class="loading-overlay">
            <div class="loading-content">
                <div class="loading-spinner"></div>
                <p>جاري تحميل البيانات...</p>
            </div>
        </div>

        <!-- إضافة النافذة المنبثقة -->
        <div id="reportModal" class="report-modal">
            <button class="close-modal" onclick="closeReportModal()">
                <i class="fas fa-times"></i>
            </button>
            <h3>الإبلاغ عن مشكلة</h3>
            <p>يمكنك التواصل معنا مباشرة عبر الأرقام التالية:</p>
            
            <div class="phone-number" onclick="callPhone('01119953955')">
                <i class="fas fa-phone"></i>
                <span>01119953955</span>
            </div>
            
            <div class="phone-number" onclick="callPhone('01033605113')">
                <i class="fas fa-phone"></i>
                <span>01033605113</span>
            </div>
            
            <p>نحن هنا لمساعدتك في أي وقت!</p>
        </div>

        <!-- إضافة قائمة الإشعارات -->
        <div class="notifications-menu" id="notificationsMenu">
            <div class="notifications-header">
                <h3>الإشعارات</h3>
                <button class="close-notifications">
                    <i class="fas fa-times"></i>
                </button>
            </div>
            <div class="notifications-list" id="notificationsList">
                <!-- سيتم إضافة الإشعارات هنا ديناميكياً -->
            </div>
        </div>

        <!-- إضافة زر المساعد الذكي الثابت -->
        <button class="ai-assistant-btn" onclick="toggleVoiceRecording()" id="aiAssistantBtn">
            <i class="fas fa-robot"></i>
        </button>

        <!-- تحديث النافذة المنبثقة -->
        <div id="voiceModal" class="modal">
            <div class="modal-content">
                <button class="close-btn" onclick="closeVoiceModal()">
                    <i class="fas fa-times"></i>
                </button>
                <div class="recording-indicator">
                    <div class="wave"></div>
                    <p id="recordingStatus">جاري التسجيل...</p>
                    <div id="processingIndicator" style="display: none;">
                        <div class="loading-spinner"></div>
                        <p class="processing-text">جاري معالجة الطلب...</p>
                    </div>
                </div>
                <div class="recording-controls">
                    <button id="stopRecordingBtn" class="stop-btn">
                        <i class="fas fa-stop"></i>
                        إيقاف التسجيل
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, get, onValue, update, push } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";
        import { getMessaging, getToken } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging.js";

        const firebaseConfig = {
            apiKey: "AIzaSyB_e0oD-74pSllN0yivBYiX-4oYbO_1PJ4",
            authDomain: "learning-8f044.firebaseapp.com",
            databaseURL: "https://learning-8f044-default-rtdb.firebaseio.com",
            projectId: "learning-8f044",
            storageBucket: "learning-8f044.firebasestorage.app",
            messagingSenderId: "453828841732",
            appId: "1:453828841732:web:99226149b359d41df64051",
            measurementId: "G-SCSBHBQM08"
        };

        // تهيئة Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getDatabase(app);
        const messaging = getMessaging(app);

        // دالة تسجيل token الجهاز
        async function registerDeviceToken() {
            try {
                const permission = await Notification.requestPermission();
                if (permission === 'granted') {
                    const token = await getToken(messaging);
                    const user = auth.currentUser;
                    if (user && token) {
                        await set(ref(db, `users/${user.uid}/deviceTokens/${token}`), {
                            timestamp: Date.now(),
                            platform: 'android'
                        });
                    }
                }
            } catch (error) {
                console.error('Error registering device token:', error);
            }
        }

        // تسجيل token الجهاز عند تسجيل الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                registerDeviceToken();
            }
        });

        // التحقق من حالة تسجيل الدخول
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // التحقق من وجود التوكن
                const token = getStorageWithExpiry('authToken');
                if (!token) {
                    // إذا لم يكن هناك توكن، نقوم بتسجيل الخروج
                    signOut(auth).then(() => {
                        window.location.href = 'index.html?reason=no_token';
                    });
                    return;
                }

                // عرض اسم المستخدم فوراً من التخزين المحلي
                document.getElementById('userNameSpan').textContent = getStorageWithExpiry('userName') || 'مستخدم';
                
                // إخفاء عنصر اسم المعهد
                document.getElementById('userInstitute').style.display = 'none';
                
                // تحديث البيانات في الخلفية
                getUserData(user.uid);
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.querySelector('.dashboard-container').classList.add('loaded');
            } else {
                // المستخدم غير مسجل دخول
                window.location.href = 'index.html?reason=not_authenticated';
            }
        });

        // جلب بيانات المستخدم
        async function getUserData(uid) {
            try {
                const userRef = ref(db, `users/${uid}`);
                const snapshot = await get(userRef);
                
                if (snapshot.exists()) {
                    const userData = snapshot.val();
                    const serverUserName = userData.name || 'مستخدم';

                    // تحديث اسم المستخدم فقط إذا كان مختلفاً
                    const localUserName = localStorage.getItem('userName');
                    if (serverUserName !== localUserName) {
                        localStorage.setItem('userName', serverUserName);
                        document.getElementById('userNameSpan').textContent = serverUserName;
                    }
                }
            } catch (error) {
                console.error("Error fetching user data:", error);
                // في حالة الخطأ، نستمر باستخدام البيانات المحلية
            }
        }

        // تسجيل الخروج
        window.logout = async function() {
            try {
                await signOut(auth);
                // مسح كل البيانات المحلية
                localStorage.clear();
                window.location.href = 'index.html?reason=user_logout';
            } catch (error) {
                console.error("Error signing out:", error);
                showToast('حدث خطأ أثناء تسجيل الخروج', 'error');
                window.location.href = 'index.html?reason=logout_error';
            }
        }

        // التنقل إلى صفحة رفع الملفات
        window.navigateToUpload = function(section) {
            window.location.href = `upload.html?section=${section}`;
        }

        // التنقل إلى صفحة المعرض
        window.navigateToGallery = function(section) {
            window.location.href = `gallery.html?section=${section}`;
        }

        // إظهار رسالة توست
        window.showToast = function(message, type = 'info') {
            Toastify({
                text: message,
                duration: 3000,
                gravity: "top",
                position: 'left',
                backgroundColor: type === 'error' ? '#ef4444' : '#3b82f6',
                className: "rtl"
            }).showToast();
        }

        // التحكم في القائمة الجانبية
        const menuBtn = document.getElementById('menuBtn');
        const sidebar = document.getElementById('sidebar');
        const sidebarOverlay = document.getElementById('sidebarOverlay');
        const closeSidebarBtn = document.getElementById('closeSidebar');

        menuBtn.addEventListener('click', () => {
            sidebar.classList.add('active');
            sidebarOverlay.style.display = 'block';
        });

        function closeSidebar() {
            sidebar.classList.remove('active');
            sidebarOverlay.style.display = 'none';
        }

        closeSidebarBtn.addEventListener('click', closeSidebar);
        sidebarOverlay.addEventListener('click', closeSidebar);

        // الإبلاغ عن مشكلة
        window.reportIssue = function() {
            document.getElementById('reportModal').style.display = 'block';
            sidebarOverlay.style.display = 'block';
        }

        window.closeReportModal = function() {
            document.getElementById('reportModal').style.display = 'none';
            sidebarOverlay.style.display = 'none';
        }

        // الاتصال بالرقم
        window.callPhone = function(phoneNumber) {
            window.location.href = `tel:${phoneNumber}`;
        }

        // إغلاق النافذة المنبثقة عند النقر خارجها
        window.addEventListener('click', (e) => {
            const modal = document.getElementById('reportModal');
            if (e.target === sidebarOverlay && modal.style.display === 'block') {
                closeReportModal();
            }
        });

        // تحميل الصفحة
        window.addEventListener('load', () => {
            setTimeout(() => {
                document.getElementById('loadingOverlay').classList.add('hidden');
                document.querySelector('.dashboard-container').classList.add('loaded');
            }, 300);
        });

        // إضافة الكود بعد تهيئة Firebase
        document.addEventListener('DOMContentLoaded', () => {
            setupNotifications();
        });

        function setupNotifications() {
            // إنشاء العناصر كما هو
            const header = document.querySelector('.header-buttons');
            if (!header.querySelector('#notificationsBtn')) {
                const notificationsBtn = document.createElement('div');
                notificationsBtn.id = 'notificationsBtn';
                notificationsBtn.className = 'notifications-btn';
                notificationsBtn.innerHTML = `
                    <i class="fas fa-bell"></i>
                    <span class="notifications-count" id="notificationsCount">0</span>
                `;
                header.insertBefore(notificationsBtn, header.firstChild);
            }

            if (!document.querySelector('#notificationsMenu')) {
                const notificationsMenu = document.createElement('div');
                notificationsMenu.id = 'notificationsMenu';
                notificationsMenu.className = 'notifications-menu';
                notificationsMenu.innerHTML = `
                    <div class="notifications-header">
                        <h3>الإشعارات</h3>
                        <button class="close-notifications">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="notifications-list" id="notificationsList"></div>
                `;
                document.querySelector('.layout').appendChild(notificationsMenu);
            }

            const notificationsBtn = document.getElementById('notificationsBtn');
            const notificationsMenu = document.getElementById('notificationsMenu');
            const notificationsList = document.getElementById('notificationsList');
            const notificationsCount = document.getElementById('notificationsCount');
            
            // استرجاع البيانات المحلية
            let localNotifications = JSON.parse(localStorage.getItem('notifications') || '{}');
            let cachedNotifications = { ...localNotifications };
            
            // تحديث العداد من البيانات المحلية
            if (notificationsCount) {
                const localUnreadCount = Object.values(localNotifications).filter(n => !n.read).length;
                notificationsCount.textContent = localUnreadCount;
            }

            function updateNotificationsList(notifications) {
                if (!notificationsList) return;
                
                if (!notifications || Object.keys(notifications).length === 0) {
                    notificationsList.innerHTML = `
                        <div style="text-align: center; padding: 2rem;">
                            <p>لا توجد إشعارات جديدة</p>
                        </div>
                    `;
                    return;
                }

                notificationsList.innerHTML = Object.entries(notifications)
                    .sort(([,a], [,b]) => b.timestamp - a.timestamp)
                    .map(([id, notification]) => createNotificationItem(id, notification))
                    .join('');
            }

            function createNotificationItem(id, notification) {
                let iconClass = '';
                switch(notification.type) {
                    case 'comment':
                        iconClass = 'comment';
                        break;
                    case 'approval':
                        iconClass = 'approval';
                        break;
                    case 'rejection':
                        iconClass = 'rejection';
                        break;
                }

                return `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" 
                         onclick="handleNotificationClick('${id}', '${notification.type}', '${notification.documentId}', '${notification.section}')">
                        <div class="notification-icon ${iconClass}">
                            <i class="fas ${getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-title">${notification.message}</div>
                            <div class="notification-time">${formatTimestamp(notification.timestamp)}</div>
                        </div>
                    </div>
                `;
            }

            // مراقبة الإشعارات في الخلفية
            const user = auth.currentUser;
            if (user) {
                const notificationsRef = ref(db, `users/${user.uid}/notifications`);
                onValue(notificationsRef, (snapshot) => {
                    const serverNotifications = snapshot.val() || {};
                    
                    // مقارنة البيانات المحلية مع بيانات السيرفر
                    if (JSON.stringify(serverNotifications) !== JSON.stringify(localNotifications)) {
                        cachedNotifications = serverNotifications;
                        localStorage.setItem('notifications', JSON.stringify(serverNotifications));
                        
                        // تحديث العداد والقائمة فقط إذا كانت مفتوحة
                        if (notificationsCount) {
                            const unreadCount = Object.values(serverNotifications).filter(n => !n.read).length;
                            notificationsCount.textContent = unreadCount;
                        }
                        
                        if (notificationsMenu && notificationsMenu.classList.contains('active')) {
                            updateNotificationsList(serverNotifications);
                        }
                    }
                });
            }

            if (notificationsBtn) {
                notificationsBtn.addEventListener('click', async () => {
                    const menu = document.getElementById('notificationsMenu');
                    const container = document.getElementById('notificationsList');
                    
                    // عرض القائمة
                    menu.classList.add('active');
                    
                    // عرض حالة التحميل
                    container.innerHTML = `
                        <div class="loading-notifications">
                            <div class="loading-spinner"></div>
                            <p>جاري تحميل الإشعارات...</p>
                        </div>
                    `;
                    
                    try {
                        // جلب الإشعارات من السيرفر مباشرة
                        const user = auth.currentUser;
                        if (user) {
                            const notificationsRef = ref(db, `users/${user.uid}/notifications`);
                            const snapshot = await get(notificationsRef);
                            const notifications = snapshot.val() || {};
                            renderNotifications(notifications);
                        }
                    } catch (error) {
                        console.error("Error loading notifications:", error);
                        container.innerHTML = '<div class="error-message">حدث خطأ في تحميل الإشعارات</div>';
                    }
                });
            }

            // إضافة مستمع لزر إغلاق الإشعارات
            document.querySelector('.close-notifications').addEventListener('click', () => {
                document.getElementById('notificationsMenu').classList.remove('active');
            });
        }

        // إضافة الدوال المساعدة خارج setupNotifications
        function getNotificationIcon(type) {
            switch(type) {
                case 'comment':
                    return 'fa-comment';
                case 'approval':
                    return 'fa-check-circle';
                case 'rejection':
                    return 'fa-times-circle';
                default:
                    return 'fa-bell';
            }
        }

        function formatTimestamp(timestamp) {
            const date = new Date(timestamp);
            return date.toLocaleDateString('ar-EG') + ' ' + date.toLocaleTimeString('ar-EG');
        }

        window.handleNotificationClick = async function(notificationId, type, docId, section) {
            const user = auth.currentUser;
            if (!user) return;

            // تحديث حالة القراءة
            const notificationRef = ref(db, `users/${user.uid}/notifications/${notificationId}`);
            await update(notificationRef, { read: true });

            // توجيه المستخدم إلى المكان المناسب
            if (type === 'new_comment') {
                window.location.href = `gallery.html?section=${section}&documentId=${docId}&showComments=true`;
            } else {
                window.location.href = `gallery.html?section=${section}&documentId=${docId}`;
            }
        }

        // إضافة دالة getStorageWithExpiry
        function getStorageWithExpiry(key) {
            const item = localStorage.getItem(key);
            if (!item) return null;
            
            try {
                const data = JSON.parse(item);
                if (Date.now() > data.expiry) {
                    localStorage.removeItem(key);
                    return null;
                }
                return data.value;
            } catch (error) {
                console.error('خطأ في قراءة البيانات المخزنة:', error);
                localStorage.removeItem(key);
                return null;
            }
        }

        // دالة إنشاء الإشعارات
        async function createNotification(userId, type, message, documentId, section) {
            try {
                const notificationRef = ref(db, `users/${userId}/notifications`);
                const newNotification = {
                    type,
                    message,
                    documentId,
                    section,
                    timestamp: Date.now(),
                    read: false
                };
                await push(notificationRef, newNotification);

                // إرسال إشعار للجهاز
                const userRef = ref(db, `users/${userId}/deviceTokens`);
                const snapshot = await get(userRef);
                const tokens = snapshot.val() || {};

                // إرسال الإشعار لكل الأجهزة المسجلة للمستخدم
                Object.keys(tokens).forEach(async (token) => {
                    try {
                        const notification = {
                            token: token,
                            notification: {
                                title: 'إشعار جديد',
                                body: message,
                                click_action: 'FLUTTER_NOTIFICATION_CLICK'
                            },
                            data: {
                                type: type,
                                documentId: documentId,
                                section: section
                            }
                        };

                        // إرسال الإشعار عبر Cloud Functions
                        const functionsRef = ref(db, 'notifications/send');
                        await push(functionsRef, notification);
                    } catch (error) {
                        console.error('Error sending push notification:', error);
                    }
                });
            } catch (error) {
                console.error("Error creating notification:", error);
            }
        }

        // دالة تحديث عداد الإشعارات
        function updateNotificationCount(count) {
            const badge = document.getElementById('notificationsCount');
            if (badge) {
                badge.textContent = count;
                if (count > 0) {
                    badge.style.display = 'flex';
                    badge.classList.add('pulse');
                } else {
                    badge.style.display = 'none';
                    badge.classList.remove('pulse');
                }
            }
        }

        // دالة عرض الإشعارات
        function renderNotifications(notifications) {
            const container = document.getElementById('notificationsList');
            if (!container) return;

            if (!notifications || Object.keys(notifications).length === 0) {
                container.innerHTML = '<div class="no-notifications">لا توجد إشعارات</div>';
                return;
            }

            const notificationsHTML = Object.entries(notifications)
                .sort(([, a], [, b]) => b.timestamp - a.timestamp)
                .map(([id, notification]) => `
                    <div class="notification-item ${notification.read ? '' : 'unread'}" 
                         onclick="handleNotificationClick('${id}', '${notification.type}', '${notification.documentId}', '${notification.section}')">
                        <div class="notification-icon ${notification.type}">
                            <i class="fas ${getNotificationIcon(notification.type)}"></i>
                        </div>
                        <div class="notification-content">
                            <div class="notification-message">${notification.message}</div>
                            <div class="notification-time">${formatTimestamp(notification.timestamp)}</div>
                        </div>
                    </div>
                `).join('');

            container.innerHTML = notificationsHTML;
        }

        // إضافة مراقب للإشعارات
        onAuthStateChanged(auth, (user) => {
            if (user) {
                const notificationsRef = ref(db, `users/${user.uid}/notifications`);
                const container = document.getElementById('notificationsList');
                if (container) {
                    container.innerHTML = `
                        <div class="loading-notifications">
                            <div class="loading-spinner"></div>
                            <p>جاري تحميل الإشعارات...</p>
                        </div>
                    `;
                }

                onValue(notificationsRef, (snapshot) => {
                    const notifications = snapshot.val() || {};
                    const unreadCount = Object.values(notifications)
                        .filter(n => !n.read).length;
                    
                    updateNotificationCount(unreadCount);
                    renderNotifications(notifications);
                });
            }
        });

        let recognition;
        const API_KEY = "NSvDh44400E6uc7PdzXZntLw1IyI3atUnQxhskQR";
        let isProcessing = false; // متغير للتحكم في حالة المعالجة
        
        // إعداد Web Speech API
        if ('webkitSpeechRecognition' in window) {
            recognition = new webkitSpeechRecognition();
            recognition.continuous = false;
            recognition.interimResults = true;
            recognition.lang = 'ar-EG';
        }

        // دالة لإغلاق النافذة وإيقاف كل العمليات
        window.closeVoiceModal = function() {
            const modal = document.getElementById('voiceModal');
            const recordingStatus = document.getElementById('recordingStatus');
            const processingIndicator = document.getElementById('processingIndicator');
            const wave = document.querySelector('.wave');
            const stopBtn = document.getElementById('stopRecordingBtn');

            // إيقاف التسجيل
            if (recognition) {
                recognition.abort();
            }

            // إيقاف المعالجة
            isProcessing = false;

            // إعادة تعيين واجهة المستخدم
            modal.style.display = 'none';
            wave.style.display = 'none';
            stopBtn.style.display = 'none';
            processingIndicator.style.display = 'none';
            recordingStatus.style.display = 'block';
            recordingStatus.textContent = 'جاري التسجيل...';
            
            document.getElementById('aiAssistantBtn').classList.remove('recording');
        };

        async function processVoiceCommand(text) {
            if (isProcessing) return; // منع المعالجة المتكررة
            isProcessing = true;
            let shouldNavigate = true; // متغير للتحكم في التنقل

            const modal = document.getElementById('voiceModal');
            const recordingStatus = document.getElementById('recordingStatus');
            const processingIndicator = document.getElementById('processingIndicator');
            const wave = document.querySelector('.wave');
            const stopBtn = document.getElementById('stopRecordingBtn');

            wave.style.display = 'none';
            stopBtn.style.display = 'none';
            recordingStatus.style.display = 'none';
            processingIndicator.style.display = 'block';

            // إضافة مستمع لزر الإغلاق
            const closeHandler = () => {
                shouldNavigate = false;
                closeVoiceModal();
            };

            // إضافة مستمعي الأحداث
            const closeBtn = document.querySelector('.close-btn');
            if (closeBtn) {
                closeBtn.addEventListener('click', closeHandler);
            }

            modal.addEventListener('click', (e) => {
                if (e.target === modal) {
                    closeHandler();
                }
            });

            try {
                const response = await fetch("https://api.cohere.ai/v1/generate", {
                    method: "POST",
                    headers: {
                        "Authorization": `Bearer ${API_KEY}`,
                        "Content-Type": "application/json"
                    },
                    body: JSON.stringify({
                        model: "command-nightly",
                        prompt: `أنت مساعد ذكي لنظام مراجعة الوثائق في المعاهد الأزهرية.
                                تم تصميمك وتدريبك بواسطة شركة MHD للتكنولوجيا.

                                يمكنك مساعدة المستخدم في:
                                1. التنقل بين أقسام النظام
                                2. رفع وإدارة الوثائق والصور
                                3. الإجابة عن الاستفسارات حول النظام
                                4. شرح كيفية استخدام الميزات المختلفة
                                5. عرض حالة الوثائق والتعليقات
                                6. إدارة الملف الشخصي والإعدادات

                                الأقسام المتاحة هي:
                                - الهيكل التنظيمي (hierarchy): يشمل الهيكل التنظيمي للمعهد والتوصيف الوظيفي
                                - اجتماعات القيادة (leadership-meetings): محاضر وقرارات اجتماعات قيادة المعهد
                                - اجتماعات المشرفين (supervisor-meetings): توثيق اجتماعات المشرفين والتوصيات
                                - اجتماعات الأسر (family-meetings): محاضر اجتماعات الأسر التعليمية
                                - الأخصائي الاجتماعي (social-specialist): سجلات وأنشطة الأخصائي الاجتماعي
                                - أمين المكتبة (librarian): سجلات المكتبة والأنشطة الثقافية
                                - التربية الرياضية (sports): سجلات وأنشطة التربية الرياضية
                                - صور عامة (general-photos): صور المعهد واللوحات الإرشادية
                                - النتيجة (results): نتائج الطلاب والإحصائيات
                                - الغياب (attendance): سجلات حضور وغياب الطلاب والمعلمين
                                - المجالات (domains): توثيق مجالات العمل والأهداف
                                - الملاحظات (notes): الملاحظات والتعليقات العامة

                                الأوامر الخاصة:
                                - "افتح معرض [اسم القسم]" -> NAVIGATE_GALLERY:[section_id]
                                - "ارفع صور [اسم القسم]" -> NAVIGATE_UPLOAD:[section_id]
                                - "اعرض/افتح الملف الشخصي" -> NAVIGATE_PROFILE
                                - "كيف أستخدم [اسم الميزة]" -> شرح تفصيلي للميزة
                                - "ما هو [اسم القسم]" -> شرح الغرض من القسم
                                - "أين أجد [نوع الوثيقة]" -> توجيه للقسم المناسب

                                أمثلة على الأسئلة والردود:
                                س: "كيف أرفع صور اجتماع القيادة؟"
                                ج: "سأوجهك لصفحة رفع صور اجتماعات القيادة. NAVIGATE_UPLOAD:leadership-meetings"

                                س: "أريد رؤية الهيكل التنظيمي"
                                ج: "سأفتح لك معرض الهيكل التنظيمي. NAVIGATE_GALLERY:hierarchy"

                                س: "كيف أضيف تعليق على الصور؟"
                                ج: "يمكنك إضافة تعليق بالضغط على أيقونة التعليقات أسفل الصورة في المعرض. التعليقات تساعد المشرفين في فهم محتوى الوثيقة."

                                المستخدم: ${text}
                                المساعد:`,
                        max_tokens: 150,
                        temperature: 0.3,
                        stop_sequences: ["المستخدم:", "\n\n"]
                    })
                });

                const data = await response.json();
                const aiResponse = data.generations[0].text.trim();

                if (aiResponse.includes('NAVIGATE_GALLERY:') ||
                    aiResponse.includes('NAVIGATE_UPLOAD:') ||
                    aiResponse.includes('NAVIGATE_PROFILE')) {
                    processingIndicator.style.display = 'none';
                    recordingStatus.style.display = 'block';
                    recordingStatus.textContent = 'جاري الانتقال...';
                    setTimeout(() => {
                        if (shouldNavigate) { // التحقق قبل التنقل
                            if (aiResponse.includes('NAVIGATE_GALLERY:')) {
                                const section = aiResponse.split('NAVIGATE_GALLERY:')[1].trim();
                                window.location.href = `gallery.html?section=${section}`;
                            } else if (aiResponse.includes('NAVIGATE_UPLOAD:')) {
                                const section = aiResponse.split('NAVIGATE_UPLOAD:')[1].trim();
                                window.location.href = `upload.html?section=${section}`;
                            } else if (aiResponse.includes('NAVIGATE_PROFILE')) {
                                window.location.href = 'profile.html';
                            }
                        }
                    }, 1000);
                } else {
                    processingIndicator.style.display = 'none';
                    recordingStatus.style.display = 'block';
                    recordingStatus.textContent = aiResponse;
                    setTimeout(() => {
                        if (shouldNavigate) {
                            modal.style.display = 'none';
                        }
                    }, 3000);
                }
            } catch (error) {
                console.error('Error:', error);
                processingIndicator.style.display = 'none';
                recordingStatus.style.display = 'block';
                recordingStatus.textContent = 'عذراً، حدث خطأ في معالجة الطلب';
                setTimeout(() => {
                    if (shouldNavigate) {
                        modal.style.display = 'none';
                    }
                }, 2000);
            } finally {
                isProcessing = false;
                // إزالة مستمعي الأحداث
                const closeBtn = document.querySelector('.close-btn');
                if (closeBtn) {
                    closeBtn.removeEventListener('click', closeHandler);
                }
                modal.removeEventListener('click', closeHandler);
            }
        }

        window.toggleVoiceRecording = async function() {
            if (isProcessing) return; // منع بدء تسجيل جديد أثناء المعالجة

            const modal = document.getElementById('voiceModal');
            const recordingStatus = document.getElementById('recordingStatus');
            const aiAssistantBtn = document.getElementById('aiAssistantBtn');
            
            try {
                if (!recognition) {
                    throw new Error('متصفحك لا يدعم تحويل الصوت إلى نص');
                }
                
                recognition.onstart = () => {
                    recordingStatus.textContent = 'جاري الاستماع...';
                    recordingStatus.style.display = 'block';
                    document.querySelector('.wave').style.display = 'block';
                    document.getElementById('stopRecordingBtn').style.display = 'block';
                    document.getElementById('processingIndicator').style.display = 'none';
                    modal.style.display = 'flex';
                    aiAssistantBtn.classList.add('recording');
                };
                
                recognition.onresult = (event) => {
                    const transcript = Array.from(event.results)
                        .map(result => result[0].transcript)
                        .join('');
                    
                    recordingStatus.textContent = transcript;
                };
                
                recognition.onend = () => {
                    const text = recordingStatus.textContent;
                    if (text && text !== 'جاري الاستماع...') {
                        processVoiceCommand(text);
                    }
                    aiAssistantBtn.classList.remove('recording');
                };
                
                recognition.onerror = (event) => {
                    console.error('Speech recognition error:', event.error);
                    recordingStatus.textContent = 'حدث خطأ في التعرف على الصوت';
                    setTimeout(() => {
                        modal.style.display = 'none';
                    }, 2000);
                };

                recognition.start();

                // إضافة مستمع لزر الإيقاف
                document.getElementById('stopRecordingBtn').onclick = () => {
                    recognition.stop();
                    closeVoiceModal();
                };

            } catch (err) {
                console.error('Error:', err);
                alert(err.message || 'حدث خطأ في تشغيل التعرف على الصوت');
            }
        };
    </script>
</body>
</html> 
